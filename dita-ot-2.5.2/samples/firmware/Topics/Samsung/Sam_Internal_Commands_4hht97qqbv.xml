<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA 1.2 Topic//EN" "/SysSchema/dita/dtd/technicalContent/dtd/topic.dtd">
<topic xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/" base="Princeton" id="Internal_Commands_4hht97qqbv" xml:lang="en-US">
  <title>Internal Commands</title>

  <body>
    <p>The following sections describe command flows that
    are initiated internally by different managers.</p>

    <section id="Flush_Internal__4iht97qqbv"><title>Flush (Internal)</title><p>This
    Flush command is issued by the Admin Command Manager to indicate that any
    data in volatile storage should be flushed to non-volatile memory.</p><fig id="Flush_Internal_Command_Control_Flow_4jht97qqbv">
        <title>Flush (Internal) Command Control
        Flow</title>

        <image href="Graphics/Admin Command Manager/Flush_Internal.svg" placement="break" width="5.5in"/>
      </fig><table id="_4kht97qqbv">
        <title>Flush (Internal) Command Control
        Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth=".5in"/>

          <colspec colname="c2" colwidth="1.5in"/>

          <colspec colname="c3" colwidth="4in"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">WriteLockReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues a write lock request for the entire LBA
              range of the specified namespace.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">LockCpl</b>
              </p></entry>

              <entry><p>The write
              lock is granted by the Locking Manager. At this point all
              outstanding commands have been completed by the Data
              Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">3</b> </p></entry>

              <entry><p> <b otherprops="bold">FlushReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues a flush request to the Mapping
              Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">4</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashWrite</b>
              </p></entry>

              <entry><p>The Mapping
              Managers flush all buffered data to flash.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">5</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashOpCpl</b>
              </p></entry>

              <entry><p>The Flash
              Interface responds to the flash write messages.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">6</b> </p></entry>

              <entry><p> <b otherprops="bold">FlushCpl</b>
              </p></entry>

              <entry><p>The Mapping
              Managers confirm that the flush operation has been
              performed.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">7</b> </p></entry>

              <entry><p> <b otherprops="bold">LockRelease</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager releases the LBA write lock.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Error_Logging_4lht97qqbv"><title>Error Logging</title><p>If a
    Data Manager (or any other manager) detects an error condition caused by
    an NVM Express I/O command it may append an entry to the error log page.
    This is achieved by sending a LogUpdate message to the Admin Command
    Manager that will perform the actual logging of the message. Other
    managers may also issue LogUpdate messages in order to log information on
    the vendor specific log pages.</p><fig id="Update_Error_Log_Control_Flow_4mht97qqbv">
        <title>Update Error Log Control Flow</title>

        <image href="Graphics/Admin Command Manager/Update_ErrorLog_Info.svg" placement="break" width="5.5in"/>
      </fig><table id="_4nht97qqbv">
        <title>Update Error Log Control Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth=".5in"/>

          <colspec colname="c2" colwidth="1.5in"/>

          <colspec colname="c3" colwidth="4in"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">LogUpdate</b>
              </p></entry>

              <entry><p>One of the
              Data Managers issues a error log update message to the Admin
              Command Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p>The Admin
              Command Manager writes the data contained in the message to the
              appropriate location in controller memory.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">PMWriteReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager then issues a protocol metadata write request to
              Mapping Manager 0 to save the log information.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">3</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashWrite</b>
              </p></entry>

              <entry><p>The Mapping
              Manager issues a flash write message to the Flash Interface to
              write the updated log page information to flash.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">4</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashCpl</b>
              </p></entry>

              <entry><p>The Flash
              Interface responds with a flash operation
              completion.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">5</b> </p></entry>

              <entry><p> <b otherprops="bold">PMOpCpl</b>
              </p></entry>

              <entry><p>When the log
              page has been successfully committed to flash Mapping Manager 0
              responds to the Admin Command Manager with a protocol metadata
              completion.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Update_SMART_Information_4oht97qqbv"><title>Update SMART Information</title><p>This command is initiated by the Admin Command Manager
    by the expiration of a timer. This command is used to periodically update
    the SMART/Health information stored in flash.</p><fig id="Update_SMART_Information_Control_Flow_4pht97qqbv">
        <title>Update SMART Information Control
        Flow</title>

        <image href="Graphics/Admin Command Manager/Get_Log_Page_Smart_Health_Timer.svg" placement="break" width="5.5in"/>
      </fig><table id="_4qht97qqbv">
        <title>Update SMART Information Control
        Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth=".5in"/>

          <colspec colname="c2" colwidth="1.5in"/>

          <colspec colname="c3" colwidth="4in"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">SMARTUpdateReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues requests to each of the Data Managers to
              obtain their SMART health information.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">DMSMARTUpdateCpl</b> </p></entry>

              <entry><p>The Data
              Managers respond with a SMART update completion message that
              contains the requested information.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">3</b> </p></entry>

              <entry><p> <b otherprops="bold">SMARTUpdateReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues a SMART update request to Mapping Manager
              0.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">4</b> </p></entry>

              <entry><p> <b otherprops="bold">FMSMARTUpdateCpl</b> </p></entry>

              <entry><p>Mapping
              Manager 0 responds to the Admin Command Manager with a message
              that contains the requested information.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">5</b> </p></entry>

              <entry><p> <b otherprops="bold">PMWriteReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues a request to write the Data Frame buffer
              that contains the SMART health information to flash to Mapping
              Manager 0.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">6</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashWrite</b>
              </p></entry>

              <entry><p>A write
              operation is issued to the Flash Interface to save the SMART
              health information.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">7</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashOpCpl</b>
              </p></entry>

              <entry><p>The Flash
              Interface responds to the flash write request.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">8</b> </p></entry>

              <entry><p> <b otherprops="bold">PMOpCpl</b>
              </p></entry>

              <entry><p>Mapping
              Manager 0 responds to the Admin Command Manager request to write
              protocol metadata.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Self_Test_4rht97qqbv"><title>Self Test</title><p>In order to
    verify the flash memory status, the flash management block needs to
    periodically perform a self-test procedure. If Data Manager 0 detects a
    period of idle time, it will issue a SelfTestReq message to Mapping
    Manager 0. The flash management block will perform an internal self test,
    then reply to the Data Manager via a SelfTestCpl message. See <xref href="Sam_Control_Flows_5bht98nxzf.xml#Control_Flows_5bht98nxzf/Self_Test_5lht98nxzf"/>
    for the complete details of this flow.</p></section>

    <section id="Update_Temperature_4sht97qqbv"><title>Update
    Temperature</title><p>This command is initiated by the
    Admin Command Manager by the expiration of a timer. This command is used
    to periodically update the temperature information.</p><fig id="Update_Temperature_Control_Flow_4tht97qqbv">
        <title>Update Temperature Control Flow</title>

        <image href="Graphics/Admin Command Manager/Admin_Temperature_Update.svg" placement="break" width="5.5in"/>
      </fig><table id="_4uht97qqbv">
        <title>Update Temperature Control Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth=".5in"/>

          <colspec colname="c2" colwidth="1.5in"/>

          <colspec colname="c3" colwidth="4in"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p>The Admin
              Manager reads temperature data.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p>The Admin
              Manager retrieves the PM SMART data from DDR and compares it
              with the predefined temperature threshold table.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">TemperatureUpdate</b> </p></entry>

              <entry><p>If any
              threshold is crossed, the Admin Manager issues <b otherprops="bold">TemperatureUpdate
              to Mapping Manager0</b> </p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p>The Admin
              Manager saves temperature to all namespace SMART/Health
              data.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>
  </body>
</topic>
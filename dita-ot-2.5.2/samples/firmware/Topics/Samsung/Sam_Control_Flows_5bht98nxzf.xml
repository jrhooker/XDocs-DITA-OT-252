<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA 1.2 Topic//EN" "/SysSchema/dita/dtd/technicalContent/dtd/topic.dtd">
<topic xmlns:ditaarch="http://dita.oasis-open.org/architecture/2005/" base="Princeton" id="Control_Flows_5bht98nxzf" xml:lang="en-US">
  <title>Control Flows</title>

  <body>
    <p>The following sections describe the control flows
    for the NVM Command Set commands received by the Data Managers from the
    host computer.</p>

    <section id="Flush_5cht98nxzf"><title>Flush</title><p>The Flush
    command is used by the host to indicate that any data in volatile storage
    should be flushed to non-volatile memory.</p><fig id="Flush_Command_Control_Flow_5dht98nxzf">
        <title>Flush Command Control Flow</title>

        <image href="Graphics/Data Manager/Flush.svg" placement="break" width="5.5in"/>
      </fig><table id="_5eht98nxzf">
        <title>Flush Command Control Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth="5*"/>

          <colspec colname="c2" colwidth="23*"/>

          <colspec colname="c3" colwidth="72*"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">CmdReady64</b>
              </p></entry>

              <entry><p>The flush
              command is received by one of the Data Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">CmdReady</b>
              </p></entry>

              <entry><p>The Data
              Manager forwards the received command to the Admin Command
              Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">3</b> </p></entry>

              <entry><p> <b otherprops="bold">WriteLockReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues a write lock request for the entire LBA
              range of the specified namespace.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">4</b> </p></entry>

              <entry><p> <b otherprops="bold">LockCpl</b>
              </p></entry>

              <entry><p>The write
              lock is granted by the Locking Manager. At this point all
              outstanding commands have been completed by the Data
              Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">5</b> </p></entry>

              <entry><p> <b otherprops="bold">FlushReq</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager issues a flush request to the Mapping
              Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">6</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashWrite</b>
              </p></entry>

              <entry><p>The Mapping
              Managers flush all buffered data to flash.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">7</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashOpCpl</b>
              </p></entry>

              <entry><p>The Flash
              Interface responds to the flash write messages.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">8</b> </p></entry>

              <entry><p> <b otherprops="bold">FlushCpl</b>
              </p></entry>

              <entry><p>The Mapping
              Managers confirm that the flush operation has been
              performed.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">9</b> </p></entry>

              <entry><p> <b otherprops="bold">LockRelease</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager releases the LBA write lock.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">10</b> </p></entry>

              <entry><p> <b otherprops="bold">CplQueueUpdate</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager sends a completion queue update request to the
              Completion Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">11</b> </p></entry>

              <entry><p> <b otherprops="bold">CplQueueUpdateCpl</b> </p></entry>

              <entry><p>The
              Completion Manager replies back to the Admin Command Manager
              when the completion has been successfully sent to the
              host.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Write_5fht98nxzf"><title>Write</title><p>The Write
    command writes data and metadata, if applicable, to the NVM controller for
    the logical blocks indicated. The host may also specify protection
    information to include as part of this operation.</p><p>When the volatile write cache is enabled, the Mapping
    Manager will issue the completion (step 11 in <xref href="#Control_Flows_5bht98nxzf/Write_Command_Control_Flow_5ght98nxzf"/>)
    to the Data Manager before the data is written to flash (steps 9 &amp; 10
    in <xref href="#Control_Flows_5bht98nxzf/Write_Command_Control_Flow_5ght98nxzf"/>).
    When the volatile write cache is disabled, the Mapping Manager will only
    issue the completion to the Data Manager after the data has been
    successfully written to flash.</p><fig id="Write_Command_Control_Flow_5ght98nxzf">
        <title>Write Command Control Flow</title>

        <image href="Graphics/Data Manager/Write.svg" placement="break" width="5.5in"/>
      </fig><table id="_5hht98nxzf">
        <title>Write Command Control Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth="5*"/>

          <colspec colname="c2" colwidth="23*"/>

          <colspec colname="c3" colwidth="72*"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">CmdReady64</b>
              </p></entry>

              <entry><p>The write
              command is received by one of the Data Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">WriteLockReq</b>
              </p></entry>

              <entry><p>The Data
              Manager issues a write lock for the Data Frame range specified
              in the write request.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">3</b> </p></entry>

              <entry><p> <b otherprops="bold">LockCpl</b>
              </p></entry>

              <entry><p>The write
              lock is granted by the Locking Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">4</b> </p></entry>

              <entry><p> <b otherprops="bold">BufferAlloc</b>
              </p></entry>

              <entry><p>The Data
              Manager breaks the request into Data Frames and obtains a Data
              Frame buffer for each Data Frame by removing a BufferOpCpl
              message from the head of the inbound IPC port from the Buffer
              Manager. Once the BufferOpCpl message has been removed, the Data
              Manager will issue a BufferAlloc message to replace the one that
              was removed.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">5</b> </p></entry>

              <entry><p> <b otherprops="bold">BufferOpCpl</b>
              </p></entry>

              <entry><p>In response
              to the BufferAlloc request message the Buffer Manager will
              respond with a BufferOpCpl message.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">6</b> </p></entry>

              <entry><p> <b otherprops="bold">IngressSectorDMA</b> </p></entry>

              <entry><p>The Data
              Manager issues ingress DMA requests to transfer data from host
              memory to the Data Frame buffer.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">7</b> </p></entry>

              <entry><p> <b otherprops="bold">DMACpl</b>
              </p></entry>

              <entry><p>The ingress
              DMA replies to the Data Managers DMA request with a DMA
              completion when the data has been transferred.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">8</b> </p></entry>

              <entry><p> <b otherprops="bold">WriteReq</b>
              </p></entry>

              <entry><p>The Data
              Manager issues a write request to the Mapping
              Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">9</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashWrite</b>
              </p></entry>

              <entry><p>A write
              request is issued to the flash.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">10</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashOpCpl</b>
              </p></entry>

              <entry><p>The Flash
              Interface responds to the flash write request.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">11</b> </p></entry>

              <entry><p> <b otherprops="bold">WriteCpl</b>
              </p></entry>

              <entry><p>The Mapping
              Manager responds to the Data Managers write request with a write
              completion.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">12</b> </p></entry>

              <entry><p> <b otherprops="bold">LockRelease</b>
              </p></entry>

              <entry><p>When all
              Data Frames have been transferred, the Data Manager releases the
              LBA range lock.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">13</b> </p></entry>

              <entry><p> <b otherprops="bold">CplQueueUpdate</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager sends a completion queue update request to the
              Completion Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">14</b> </p></entry>

              <entry><p> <b otherprops="bold">CplQueueUpdateCpl</b> </p></entry>

              <entry><p>The
              Completion Manager replies back to the Admin Command Manager
              when the completion has been successfully sent to the
              host.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">15</b> </p></entry>

              <entry><p> <b otherprops="bold">BufferFree</b>
              </p></entry>

              <entry><p>When no
              longer needed, the FTL frees the Data Frame buffer allocated by
              the Data Manager.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Read_5iht98nxzf"><title>Read</title><p>The Read command
    reads data and metadata, if applicable, from the NVM controller for the
    LBA's indicated. The command may specify protection information to be
    checked as part of the read operation.</p><fig id="Read_Command_Control_Flow_5jht98nxzf">
        <title>Read Command Control Flow</title>

        <image href="Graphics/Data Manager/Read.svg" placement="break" width="5.5in"/>
      </fig><table id="_5kht98nxzf">
        <title>Read Command Control Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth="5*"/>

          <colspec colname="c2" colwidth="23*"/>

          <colspec colname="c3" colwidth="72*"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">CmdReady64</b>
              </p></entry>

              <entry><p>The read
              command is received by one of the Data Managers.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">ReadLockReq</b>
              </p></entry>

              <entry><p>The Data
              Manager issues a read lock for the Data Frame range specified in
              the write request.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">3</b> </p></entry>

              <entry><p> <b otherprops="bold">LockCpl</b>
              </p></entry>

              <entry><p>The read
              lock is granted by the Locking Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">4</b> </p></entry>

              <entry><p> <b otherprops="bold">BufferAlloc</b>
              </p></entry>

              <entry><p>The Data
              Manager breaks the request in to Data Frames and obtains a Data
              Frame buffer for each Data Frame by removing a BufferOpCpl
              message from the head of the inbound IPC port from the Buffer
              Manager. Once the BufferOpCpl message has been removed, the Data
              Manager will issue a BufferAlloc message to replace the one that
              was removed.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">5</b> </p></entry>

              <entry><p> <b otherprops="bold">BufferOpCpl</b>
              </p></entry>

              <entry><p>In response
              to the BufferAlloc request message, the Buffer Manager will
              respond with a BufferOpCpl message.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">6</b> </p></entry>

              <entry><p> <b otherprops="bold">ReadReq</b>
              </p></entry>

              <entry><p>The Data
              Manager issues a flash read request to the Mapping
              Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">7</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashRead</b>
              </p></entry>

              <entry><p>The Mapping
              Manager issues a flash read request to the Flash
              Interface.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">8</b> </p></entry>

              <entry><p> <b otherprops="bold">FlashOpCpl</b>
              </p></entry>

              <entry><p>The Flash
              Interface responds to the flash read request.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">9</b> </p></entry>

              <entry><p> <b otherprops="bold">ReadCpl</b>
              </p></entry>

              <entry><p>The Mapping
              Manager sends a read completion to the Data Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">10</b> </p></entry>

              <entry><p> <b otherprops="bold">EgressSectorDMA</b>
              </p></entry>

              <entry><p>The Data
              Manager issues egress DMA requests to transfer the data from the
              Data Frame buffer to host memory.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">11</b> </p></entry>

              <entry><p> <b otherprops="bold">DMACpl</b>
              </p></entry>

              <entry><p>The egress
              DMA responds to egress DMA requests when the data has been
              transferred to host memory.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">12</b> </p></entry>

              <entry><p> <b otherprops="bold">BufferFree</b>
              </p></entry>

              <entry><p>A request is
              issued to the Buffer Manager to free the Data Frame
              buffer.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">13</b> </p></entry>

              <entry><p> <b otherprops="bold">LockRelease</b>
              </p></entry>

              <entry><p>When all
              Data Frames have been transferred, the Data Manager releases the
              LBA range lock.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">14</b> </p></entry>

              <entry><p> <b otherprops="bold">CplQueueUpdate</b>
              </p></entry>

              <entry><p>The Admin
              Command Manager sends a completion queue update request to the
              Completion Manager.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">15</b> </p></entry>

              <entry><p> <b otherprops="bold">CplQueueUpdateCpl</b> </p></entry>

              <entry><p>The
              Completion Manager replies back to the Admin Command Manager
              when the completion has been successfully sent to the
              host.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Self_Test_5lht98nxzf"><title>Self Test</title><p>In order to
    verify the flash memory status, the flash management block needs to
    periodically perform a self-test procedure. If Data Manager 0 detects a
    period of idle time, it will issue a SelfTestReq message to Mapping
    Manager 0. The flash management block will perform an internal self test
    and then reply to the Data Manager via a SelfTestCpl message.</p><fig id="Self_Test_Command_Control_Flow_5mht98nxzf">
        <title>Self Test Command Control Flow</title>

        <image href="Graphics/Data Manager/Self_Test.svg" placement="break" width="5.5in"/>
      </fig><table id="_5nht98nxzf">
        <title>Self Test Command Control Flow</title>

        <tgroup cols="3">
          <colspec colname="c1" colwidth="5*"/>

          <colspec colname="c2" colwidth="23*"/>

          <colspec colname="c3" colwidth="72*"/>

          <thead>
            <row>
              <entry>No.</entry>

              <entry>Message</entry>

              <entry>Description</entry>
            </row>
          </thead>

          <tbody>
            <row>
              <entry><p> <b otherprops="bold">1</b> </p></entry>

              <entry><p> <b otherprops="bold">SelfTestReq</b>
              </p></entry>

              <entry><p>Data Manager
              0 detects a period of idle time and issues a self-test request
              to Mapping Manager 0.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p> <b otherprops="bold">-</b> </p></entry>

              <entry><p>The flash
              management block performs the self test.</p></entry>
            </row>

            <row>
              <entry><p> <b otherprops="bold">2</b> </p></entry>

              <entry><p> <b otherprops="bold">SelfTestCpl</b>
              </p></entry>

              <entry><p>Mapping
              Manager 0 replies to Data Manager 0 with a self-test completion
              message.</p></entry>
            </row>
          </tbody>
        </tgroup>
      </table></section>

    <section id="Error_Logging_5oht98nxzf"><title>Error Logging</title><p>If a
    Data Manager (or any other manager) detects an error condition caused by
    an NVM Express I/O command, it may append an entry to the error log page.
    This is achieved by sending a LogUpdate message to the Admin Command
    Manager, which will perform the actual logging of the message. Managers
    may also issue LogUpdate messages in order to log information in the
    vendor specific log pages. See <xref href="Sam_Internal_Commands_4hht97qqbv.xml#Internal_Commands_4hht97qqbv/Update_Error_Log_Control_Flow_4mht97qqbv"/>
    for the complete details of this flow.</p></section>
  </body>
</topic>